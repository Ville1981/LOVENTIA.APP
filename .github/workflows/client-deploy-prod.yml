# File: .github/workflows/client-deploy-prod.yml

name: Client Deploy (prod)

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
  build-deploy:
    name: Build client, deploy to S3, invalidate CloudFront (prod)
    runs-on: ubuntu-latest
    environment: production

    defaults:
      run:
        working-directory: client

    env:
      AWS_REGION: ${{ vars.AWS_REGION != '' && vars.AWS_REGION || 'eu-north-1' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          # cache disabled (avoid cache path issues)
          # cache: npm
          # cache-dependency-path: client/package-lock.json

      # -------------------------------------------------------------
      # Install deps (ROOT)
      # -------------------------------------------------------------
      - name: Install dependencies
        working-directory: .
        shell: bash
        run: |
          # --- REPLACE START: ensure optional deps are allowed (native binaries) ---
          set -euo pipefail

          echo "== Install dependencies (root) =="
          echo "Node: $(node --version)"
          echo "npm:  $(npm --version)"
          echo "PWD:  $(pwd)"

          # Ensure optional deps are not omitted (native/platform binaries can come via optionalDependencies)
          export npm_config_optional=true
          export npm_config_omit=""

          npm ci
          # --- REPLACE END ---

      # -------------------------------------------------------------
      # Repair lightningcss native binary (Linux)
      # -------------------------------------------------------------
      - name: Repair lightningcss native binary (Linux)
        if: runner.os == 'Linux'
        working-directory: .
        shell: bash
        run: |
          set -euo pipefail

          echo "== lightningcss sanity check (Linux runner) =="
          EXPECTED="node_modules/lightningcss/lightningcss.linux-x64-gnu.node"

          if [[ -f "$EXPECTED" ]]; then
            echo "OK: Found $EXPECTED"
            exit 0
          fi

          echo "::warning::Missing $EXPECTED. Attempting repair..."

          if [[ -f "node_modules/lightningcss/package.json" ]]; then
            echo "lightningcss version: $(node -p "require('./node_modules/lightningcss/package.json').version")"
          else
            echo "::error::node_modules/lightningcss/package.json not found."
            exit 1
          fi

          CANDIDATE="$(node -e "try{const pkg=require('./node_modules/lightningcss/package.json');const opt=Object.keys(pkg.optionalDependencies||{});const p=process.platform;const a=process.arch;const pick=opt.find(k=>k.includes(p)&&k.includes(a)&&k.includes('gnu'))||opt.find(k=>k.includes(p)&&k.includes(a))||'';process.stdout.write(pick);}catch(e){process.stdout.write('');}")"

          if [[ -z "$CANDIDATE" ]]; then
            echo "::error::Could not detect optionalDependencies candidate for lightningcss."
            node -e "try{console.log(require('./node_modules/lightningcss/package.json').optionalDependencies)}catch(e){console.error(e)}"
            exit 1
          fi

          echo "Detected lightningcss optional package candidate: $CANDIDATE"

          TMP="$(mktemp -d)"
          pushd "$TMP" >/dev/null
          npm pack "$CANDIDATE"
          TARBALL="$(ls -1 *.tgz | head -n1)"
          tar -xzf "$TARBALL"
          popd >/dev/null

          if [[ ! -f "$TMP/package/lightningcss.linux-x64-gnu.node" ]]; then
            echo "::error::Packed optional package did not contain lightningcss.linux-x64-gnu.node"
            ls -la "$TMP/package" || true
            exit 1
          fi

          cp -f "$TMP/package/lightningcss.linux-x64-gnu.node" "$EXPECTED"
          rm -rf "$TMP"

          ls -la node_modules/lightningcss || true

          if [[ ! -f "$EXPECTED" ]]; then
            echo "::error::lightningcss native binary still missing: $EXPECTED"
            exit 1
          fi

          echo "OK: Repaired lightningcss native binary: $EXPECTED"

      # -------------------------------------------------------------
      # --- NEW: Repair @tailwindcss/oxide native binary (Linux)
      # -------------------------------------------------------------
      - name: Repair tailwindcss-oxide native binary (Linux)
        if: runner.os == 'Linux'
        working-directory: .
        shell: bash
        run: |
          set -euo pipefail

          echo "== @tailwindcss/oxide sanity check (Linux runner) =="

          LOCAL="node_modules/@tailwindcss/oxide/tailwindcss-oxide.linux-x64-gnu.node"
          PKGDIR="node_modules/@tailwindcss/oxide-linux-x64-gnu"

          if [[ -f "$LOCAL" && -d "$PKGDIR" ]]; then
            echo "OK: Found $LOCAL and $PKGDIR"
            exit 0
          fi

          if [[ ! -f "node_modules/@tailwindcss/oxide/package.json" ]]; then
            echo "::error::node_modules/@tailwindcss/oxide/package.json not found. Cannot repair."
            exit 1
          fi

          echo "::warning::Missing Tailwind Oxide native binding. Attempting repair..."
          echo "oxide version: $(node -p "require('./node_modules/@tailwindcss/oxide/package.json').version")"

          CANDIDATE="$(node -e "try{const pkg=require('./node_modules/@tailwindcss/oxide/package.json');const opt=Object.keys(pkg.optionalDependencies||{});const p=process.platform;const a=process.arch;const pick=opt.find(k=>k.includes(p)&&k.includes(a)&&k.includes('gnu'))||opt.find(k=>k.includes(p)&&k.includes(a))||'';process.stdout.write(pick);}catch(e){process.stdout.write('');}")"

          if [[ -z "$CANDIDATE" ]]; then
            echo "::error::Could not detect optionalDependencies candidate for @tailwindcss/oxide."
            node -e "try{console.log(require('./node_modules/@tailwindcss/oxide/package.json').optionalDependencies)}catch(e){console.error(e)}"
            exit 1
          fi

          echo "Detected oxide optional package candidate: $CANDIDATE"

          TMP="$(mktemp -d)"
          pushd "$TMP" >/dev/null
          npm pack "$CANDIDATE"
          TARBALL="$(ls -1 *.tgz | head -n1)"
          tar -xzf "$TARBALL"
          popd >/dev/null

          mkdir -p node_modules/@tailwindcss
          rm -rf "$PKGDIR"
          mv "$TMP/package" "$PKGDIR"
          rm -rf "$TMP"

          # Copy the native .node also into @tailwindcss/oxide (some versions try local require first)
          if [[ -f "$PKGDIR/tailwindcss-oxide.linux-x64-gnu.node" ]]; then
            mkdir -p node_modules/@tailwindcss/oxide
            cp -f "$PKGDIR/tailwindcss-oxide.linux-x64-gnu.node" "$LOCAL" || true
          fi

          echo "== oxide diagnostics =="
          ls -la node_modules/@tailwindcss/oxide || true
          ls -la "$PKGDIR" || true

          if [[ ! -d "$PKGDIR" ]]; then
            echo "::error::Missing platform package directory after repair: $PKGDIR"
            exit 1
          fi

          echo "OK: Installed $PKGDIR"
          if [[ -f "$LOCAL" ]]; then
            echo "OK: Installed $LOCAL"
          else
            echo "::warning::Local oxide .node not found ($LOCAL), but platform package exists; build should still pass."
          fi

      # -------------------------------------------------------------
      # Build (Vite)
      # -------------------------------------------------------------
      - name: Build
        env:
          CLIENT_URL: ${{ secrets.CLIENT_URL }}
          VITE_API_BASE_URL: ${{ secrets.VITE_API_BASE_URL }}
        run: npm run build

      # -------------------------------------------------------------
      # AWS credentials via OIDC
      # -------------------------------------------------------------
      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ vars.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}
          audience: sts.amazonaws.com

      - name: Resolve S3 bucket (prod)
        id: bucket
        shell: bash
        env:
          S3_BUCKET_PROD_VAR: ${{ vars.S3_BUCKET_PROD }}
          S3_BUCKET_PROD_SECRET: ${{ secrets.S3_BUCKET_PROD }}
        run: |
          if [[ -n "$S3_BUCKET_PROD_VAR" ]]; then
            echo "value=$S3_BUCKET_PROD_VAR" >> "$GITHUB_OUTPUT"
          else
            echo "value=$S3_BUCKET_PROD_SECRET" >> "$GITHUB_OUTPUT"
          fi

      - name: Upload to S3
        shell: bash
        run: |
          BUCKET="${{ steps.bucket.outputs.value }}"
          if [[ -z "$BUCKET" ]]; then
            echo "::error::S3 bucket not resolved (check vars/secrets: S3_BUCKET_PROD)."
            exit 1
          fi
          aws s3 sync dist "s3://${BUCKET}" --delete

      - name: Resolve CloudFront distribution (prod)
        id: cf
        shell: bash
        run: |
          if [[ -n "${{ vars.CF_DISTRIBUTION_ID_PROD }}" ]]; then
            echo "id=${{ vars.CF_DISTRIBUTION_ID_PROD }}" >> "$GITHUB_OUTPUT"
          else
            echo "id=${{ secrets.CLOUDFRONT_DISTRIBUTION_ID_PROD }}" >> "$GITHUB_OUTPUT"
          fi

      - name: Invalidate CloudFront
        shell: bash
        run: |
          DIST_ID="${{ steps.cf.outputs.id }}"
          if [[ -z "$DIST_ID" ]]; then
            echo "::error::CloudFront Distribution ID not resolved (vars/secrets: CF_DISTRIBUTION_ID_PROD)."
            exit 1
          fi
          aws cloudfront create-invalidation --distribution-id "${DIST_ID}" --paths "/*"

      - name: Deployment summary
        shell: bash
        run: |
          echo "Branch: ${GITHUB_REF_NAME}"
          echo "Region: ${AWS_REGION}"
          echo "S3 bucket: ${{ steps.bucket.outputs.value }}"
          echo "CloudFront: ${{ steps.cf.outputs.id }}"

