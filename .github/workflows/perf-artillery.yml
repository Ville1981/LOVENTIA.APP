env:

  TEST_PASSWORD: ${{ secrets.TEST_PASSWORD }}
  PERF_PASSWORD: ${{ secrets.PERF_PASSWORD }}
  CYPRESS_TEST_PASSWORD: ${{ secrets.CYPRESS_TEST_PASSWORD }}
# --- REPLACE START: optional perf smoke (manual) ---
name: perf-artillery

on:
  workflow_dispatch:
    inputs:
      target:
        description: "Base URL (e.g., https://staging.example.com)"
        required: false
        default: "https://staging.example.com"

jobs:
  perf:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Install Artillery
        run: npm i -g artillery@2
      - name: Run test
        working-directory: server
        env:
          TARGET: ${{ github.event.inputs.target }}
        run: |
          artillery run perf/artillery-auth-discover-message.yml -o artillery-report.json
      - name: Upload report
        uses: actions/upload-artifact@v4
        with:
          name: artillery-report
          path: server/artillery-report.json
# --- REPLACE END ---
# File: .github/workflows/perf-artillery.yml

# --- REPLACE START: optional perf check against staging (manual) ---
name: perf-artillery

on:
  workflow_dispatch:
    inputs:
      target:
        description: 'Target base URL'
        required: true
        default: 'https://staging.example.com'
      email:
        description: 'Perf user email'
        required: false
      password:
        description: 'Perf user password'
        required: false

jobs:
  perf:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Install Artillery
        run: npm i -g artillery@2
      - name: Run load scenario
        env:
          PERF_TARGET: ${{ github.event.inputs.target }}
          PERF_EMAIL: ${{ github.event.inputs.email || secrets.PERF_EMAIL }}
          PERF_PASSWORD: ${{ github.event.inputs.password || secrets.PERF_PASSWORD }}
        run: |
          artillery run perf/artillery/auth-discover-chat.yml -o artillery-report.json
      - name: Upload report
        uses: actions/upload-artifact@v4
        with:
          name: artillery-report
          path: artillery-report.json
# --- REPLACE END ---
