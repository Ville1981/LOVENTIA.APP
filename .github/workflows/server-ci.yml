# File: .github/workflows/server-ci.yml

# NOTE:
# - This workflow keeps the original structure (no unnecessary shortening) and
#   adds what was missing: least-privilege permissions, Mongo service for tests,
#   environment-scoped secrets wiring, coverage & artifacts.
# - The replacement region is clearly marked.

# --- REPLACE START: maintain full pipeline (lint → audit → test+coverage → OpenAPI → build → artifacts → diagnostics); keep env secrets ---
name: server-ci

on:
  push:
    branches: [ main, dev, 'varaoksa*' ]
  pull_request:
    branches: [ main, dev, 'varaoksa*' ]

# Least-privilege: allow reading repo and (optionally) OIDC later
permissions:
  id-token: write
  contents: read

jobs:
  server-ci:
    name: Server CI (lint • audit • test • openapi • build)
    runs-on: ubuntu-latest

    # Use the GitHub Environment "staging" so this job gets environment-scoped secrets.
    environment: staging

    # Keep commands scoped to the server workspace by default
    defaults:
      run:
        working-directory: server

    # MongoDB service for integration tests. Version can be tuned if needed.
    services:
      mongo:
        image: mongo:6
        ports:
          - 27017:27017
        # Basic healthcheck ensures DB is ready before tests begin.
        options: >-
          --health-cmd="mongosh --quiet --eval 'db.runCommand({ ping: 1 })'"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=10

    # CI/test environment. We provide safe defaults; environment-scoped secrets
    # will override selected vars in a step below (see: "Resolve env from secrets").
    env:
      NODE_ENV: test
      PORT: 5001

      # Local Mongo for CI tests by default
      MONGO_URI: mongodb://127.0.0.1:27017/loventia_ci
      MONGODB_URI: mongodb://127.0.0.1:27017/loventia_ci

      # Defaults so imports/config don’t explode in CI
      CLIENT_URL: http://localhost:5174

      # JWT / Stripe placeholders (overridden by env secrets if present)
      JWT_SECRET: test_secret
      JWT_REFRESH_SECRET: test_refresh_secret
      STRIPE_MOCK_MODE: "1"
      STRIPE_SECRET_KEY: sk_test_dummy
      STRIPE_WEBHOOK_SECRET: whsec_dummy
      STRIPE_PRICE_ID: price_dummy

      # JUnit output file (harmless if jest-junit is not installed)
      JEST_JUNIT_OUTPUT: ./test-results/junit.xml

      # Optional test creds (from environment secrets); do not echo
      TEST_PASSWORD: ${{ secrets.TEST_PASSWORD }}
      PERF_PASSWORD: ${{ secrets.PERF_PASSWORD }}
      CYPRESS_TEST_PASSWORD: ${{ secrets.CYPRESS_TEST_PASSWORD }}

    steps:
      # 1) Checkout repository
      - name: Checkout
        uses: actions/checkout@v4

      # 2) Node setup with npm cache scoped to /server lockfile
      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: server/package-lock.json

      # 3) Install dependencies
      - name: Install deps (server)
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi

      # 4) Resolve env from environment-scoped secrets (staging)
      #    Only overwrite defaults if a secret is set (keeps local CI DB for tests).
      - name: Resolve env from secrets (staging)
        shell: bash
        run: |
          # URLs
          if [ -n "${{ secrets.CLIENT_URL }}" ]; then echo "CLIENT_URL=${{ secrets.CLIENT_URL }}" >> "$GITHUB_ENV"; fi

          # Mongo (used by app build/start — tests still target local mongo via MONGO_URI above)
          if [ -n "${{ secrets.MONGODB_URI }}" ]; then echo "MONGODB_URI=${{ secrets.MONGODB_URI }}" >> "$GITHUB_ENV"; fi

          # JWT
          if [ -n "${{ secrets.JWT_SECRET }}" ]; then echo "JWT_SECRET=${{ secrets.JWT_SECRET }}" >> "$GITHUB_ENV"; fi
          if [ -n "${{ secrets.JWT_REFRESH_SECRET }}" ]; then echo "JWT_REFRESH_SECRET=${{ secrets.JWT_REFRESH_SECRET }}" >> "$GITHUB_ENV"; fi

          # Stripe
          if [ -n "${{ secrets.STRIPE_SECRET_KEY }}" ]; then echo "STRIPE_SECRET_KEY=${{ secrets.STRIPE_SECRET_KEY }}" >> "$GITHUB_ENV"; fi
          if [ -n "${{ secrets.STRIPE_WEBHOOK_SECRET }}" ]; then echo "STRIPE_WEBHOOK_SECRET=${{ secrets.STRIPE_WEBHOOK_SECRET }}" >> "$GITHUB_ENV"; fi
          if [ -n "${{ secrets.STRIPE_PRICE_ID }}" ]; then echo "STRIPE_PRICE_ID=${{ secrets.STRIPE_PRICE_ID }}" >> "$GITHUB_ENV"; fi

      # 5) Lint (no-op if script missing)
      - name: Lint
        run: npm run lint --if-present

      # 6) Security audit (npm audit & depcheck) — non-failing, with artifacts
      - name: Security audit (npm audit & depcheck)
        run: |
          mkdir -p security-reports
          # npm audit: capture JSON + text summary; do not fail the build
          npm audit --audit-level=high --json > security-reports/npm-audit.json || true
          npm audit --audit-level=high > security-reports/npm-audit.txt || true
          # depcheck: capture JSON + text; do not fail the build
          npx depcheck --json > security-reports/depcheck.json || true
          npx depcheck > security-reports/depcheck.txt || true

      - name: Upload security reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: server-security-reports
          path: server/security-reports/*
          if-no-files-found: warn

      # 7) Unit/Integration tests with coverage. Reporters line is safe even if jest-junit isn’t present.
      - name: Test (Jest/Vitest) with coverage
        run: |
          mkdir -p test-results
          npm test --if-present -- \
            --ci \
            --coverage \
            --reporters=default \
            --reporters=jest-junit

      # 8) Upload coverage folder regardless of success, for debugging flakes
      - name: Upload coverage artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: server-coverage
          path: server/coverage
          if-no-files-found: warn

      # 9) Upload JUnit XML (if produced)
      - name: Upload test-results (JUnit)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: server-test-results
          path: server/test-results
          if-no-files-found: ignore

      # 10) OpenAPI validate & bundle (no-op if script not defined)
      - name: OpenAPI validate & bundle
        run: npm run openapi:build --if-present

      # 11) Upload OpenAPI distributables
      - name: Upload OpenAPI artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: openapi-dist
          path: server/openapi/dist/*
          if-no-files-found: ignore

      # 12) Build (TS transpile / bundling). Safe if script not present.
      - name: Build server
        run: npm run build --if-present

      # 13) Upload build output and (optionally) OpenAPI root dir if it exists
      - name: Upload build artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: server-build
          path: |
            server/dist
            server/openapi
          if-no-files-found: ignore

      # 14) Upload diagnostics (docs) — optional helper scripts for developers
      - name: Upload diagnostics (docs)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: server-diagnostics
          path: server/docs/diagnostics/*
          if-no-files-found: warn

      # 15) On failure, publish npm logs for easier debugging
      - name: Upload npm logs (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: server-npm-logs
          path: ~/.npm/_logs
          if-no-files-found: ignore
# --- REPLACE END ---
