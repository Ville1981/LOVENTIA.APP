# secrets are set per-job so the 'secrets' context is valid at job runtime
name: Security Scans

on:
  workflow_dispatch:
  schedule:
    - cron: '0 3 * * 0'  # Sundays at 03:00 UTC

jobs:
  zap-scan:
    runs-on: ubuntu-latest
    env:
      TEST_PASSWORD: ${{ secrets.TEST_PASSWORD }}
      PERF_PASSWORD: ${{ secrets.PERF_PASSWORD }}
      CYPRESS_TEST_PASSWORD: ${{ secrets.CYPRESS_TEST_PASSWORD }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      - name: Run OWASP ZAP scan
        run: |
          docker run --rm \
            -v $(pwd)/security/zap-config.json:/zap/config/zap-config.json \
            -v $(pwd)/zap-report:/zap/report \
            owasp/zap2docker-stable zap.sh \
            -cmd -configfile /zap/config/zap-config.json \
            -quickurl http://localhost:3000 \
            -quickout /zap/report/zap-report.html

      - name: Upload ZAP report
        # --- REPLACE START: bump upload-artifact to v4 ---
        uses: actions/upload-artifact@v4
        with:
          name: zap-report
          path: |
            zap-report/*.html
            zap-report/*.xml
        # --- REPLACE END

  dependency-scan:
    runs-on: ubuntu-latest
    env:
      TEST_PASSWORD: ${{ secrets.TEST_PASSWORD }}
      PERF_PASSWORD: ${{ secrets.PERF_PASSWORD }}
      CYPRESS_TEST_PASSWORD: ${{ secrets.CYPRESS_TEST_PASSWORD }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      # --- REPLACE START: dependency scanning for server + client with high/critical only ---
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Install server dependencies
        working-directory: server
        run: npm ci

      - name: Server npm audit (production, high+ only)
        working-directory: server
        run: |
          npm audit --production --audit-level=high --json > ../audit-server.json

      - name: Install client dependencies
        working-directory: client
        run: npm ci

      - name: Client npm audit (production, high+ only)
        working-directory: client
        run: |
          npm audit --production --audit-level=high --json > ../audit-client.json

      - name: Upload dependency audit reports
        # --- bump upload-artifact to v4 ---
        uses: actions/upload-artifact@v4
        with:
          name: dependency-audit-reports
          path: |
            audit-server.json
            audit-client.json
      # --- REPLACE END


