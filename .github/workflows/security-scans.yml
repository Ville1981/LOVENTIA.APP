name: Security Scans

on:
  workflow_dispatch:
  schedule:
    - cron: '0 3 * * 0' # Sundays at 03:00 UTC

jobs:
  zap-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install OWASP ZAP Docker image
        run: docker pull owasp/zap2docker-stable

      - name: Run OWASP ZAP scan
        run: |
          docker run --rm \
            -v $(pwd)/security/zap-config.json:/zap/config/zap-config.json \
            -v $(pwd)/zap-report:/zap/report \
            owasp/zap2docker-stable zap.sh \
            -cmd -configfile /zap/config/zap-config.json \
            -quickurl http://localhost:3000 \
            -quickout /zap/report/zap-report.html

      - name: Upload ZAP report
        uses: actions/upload-artifact@v3
        with:
          name: zap-report
          path: zap-report/*.html, zap-report/*.xml

  dependency-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      # --- REPLACE START: inline dependency scanning rather than external workflow
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '16'

      - name: Install dependencies
        run: npm ci

      - name: Run npm audit
        run: npm audit --audit-level=moderate

      - name: Run Gradle Dependency Check
        run: |
          if [ -f gradlew ]; then
            chmod +x gradlew
            ./gradlew dependencyCheckAnalyze
          fi

      - name: Upload dependency check reports
        uses: actions/upload-artifact@v3
        with:
          name: dependency-check-report
          path: |
            reports/dependency-check-report.html
            reports/dependency-check-report.xml
      # --- REPLACE END
